{% extends "base.html" %}

{% load static %}

{% block head %}
    <script src="{% static 'js/pixi.min.js' %}"></script>
{% endblock %}

{% block title %}
    Главная
{% endblock %}

{% block content %}

{% endblock %}

{% block foot %}
<script>
    const app = new PIXI.Application({width: 1200, height: 800});
    document.body.appendChild(app.view);
    const {stage} = app;

    // prepare circle texture, that will be our brush
    const brush = new PIXI.Graphics();
    brush.beginFill(0xffffff);
    brush.drawCircle(0, 0, 500);
    brush.endFill();

    app.loader.add('crop_bad', '{% static 'img/textures/crop_bad.jpg' %}');
    app.loader.add('crop_good', '{% static 'img/textures/crop_good.jpg' %}');
    app.loader.add('badland', '{% static 'img/textures/badland.jpg' %}');
    app.loader.add('drone', '{% static 'img/textures/drone.png' %}');
    app.loader.add('pickup', '{% static 'img/textures/pickup.png' %}');
    app.loader.load(setup);

    function setup(loader, resources) {
        const background = new PIXI.Sprite(resources.badland.texture);
        stage.addChild(background);
        background.width = app.screen.width;
        background.height = app.screen.height;

        let field = new PIXI.Graphics();
        field.beginFill(0);
        var fieldTiling = new PIXI.Sprite(resources.crop_bad.texture);
        fieldTiling.width = app.screen.width;
        fieldTiling.height = app.screen.height;
        stage.addChild(fieldTiling);
        field.drawPolygon({{ field|safe }});
        field.endFill();
        stage.addChild(field);
        fieldTiling.mask = field;

        {#const renderTexture = PIXI.RenderTexture.create(1200, 800);#}
        {#const renderTextureSprite = new PIXI.TilingSprite(renderTexture);#}
        {#stage.addChild(renderTextureSprite);#}
        {#fieldReady.mask = renderTextureSprite;#}
        {#fieldReadyTiling.mask = fieldReady;#}

        var drones = [];
        var initial = {{ initial|safe }};
        for(i = 0; i < {{ number_of_drones }}; i++) {
            const drone = new PIXI.Sprite(resources.drone.texture);
            stage.addChild(drone);
            drone.x = initial[0];
            drone.y = initial[1];
            drone.width = 64;
            drone.height = 64;
            drones.push(drone);
        }

        const pickup = new PIXI.Sprite(resources.pickup.texture);
        stage.addChild(pickup);
        pickup.x = initial[0];
        pickup.y = initial[1];
        pickup.height = 70;
        pickup.width = 166;

        // Draw grid
        let grid = {{ grid|safe }};
        for(let point of grid){
            let gridCircle = new PIXI.Graphics();
            gridCircle.beginFill(0x00cc14);
            stage.addChild(gridCircle);
            gridCircle.x = point[0];
            gridCircle.y = point[1];
            gridCircle.drawCircle(0, 0, 10);
            gridCircle.endFill();
        }

        var waypoints = {{ waypoints|safe }}

        app.ticker.add(delta => gameLoop(delta));

        var droneSpeed = 5;
        function gameLoop(delta) {
            let i = 0;
            for(let drone of drones){
                if(waypoints[i].length === 0) {
                    i++;
                    continue;
                }
                let my_waypoint = waypoints[i][0];
                let delta_x = my_waypoint[0] - drone.height / 2 - drone.x;
                let delta_y = my_waypoint[1] - drone.height / 2 - drone.y;
                let delta = Math.sqrt(delta_x * delta_x + delta_y * delta_y);
                delta_x /= delta;
                delta_y /= delta;

                drone.x += delta_x * droneSpeed;
                drone.y += delta_y * droneSpeed;

                if (Math.abs(drone.x + drone.height / 2 - my_waypoint[0]) < droneSpeed / 2 &&
                    Math.abs(drone.y + drone.height / 2 - my_waypoint[1]) < droneSpeed / 2) {
                    waypoints[i].shift();
                }
                i++;
            }
        }
    }
</script>
{% endblock %}
